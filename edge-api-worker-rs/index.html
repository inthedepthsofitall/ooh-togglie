<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OOH Toggle It — Live Flags</title>
    <style>
      :root{--bg:#0b0c10;--card:#16181d;--fg:#e6e6e6;--muted:#98a2b3;--ok:#22c55e;--no:#ef4444}
      *{box-sizing:border-box} body{margin:0;background:#0b0c10;color:var(--fg);font-family:system-ui,Segoe UI,Roboto,Arial}
      .wrap{max-width:980px;margin:32px auto;padding:0 16px}
      .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;padding:16px 18px}
      h1{font-size:22px;margin:0 0 12px} h2{font-size:16px;margin:0 0 8px;color:#e2e8f0}
      input,button{border-radius:10px;border:1px solid #2b3441;background:#0f172a;color:var(--fg);padding:10px 12px}
      button{cursor:pointer}
      .grid{display:grid;gap:16px;grid-template-columns:1fr 1fr}
      .row{display:flex;gap:8px;align-items:center}
      .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;background:#0b1220;border:1px solid #1f2937}
      .ok{color:var(--ok)} .no{color:var(--no)} .muted{color:var(--muted)}
      pre{margin:0;background:#0b1220;border:1px solid #1f2937;border-radius:12px;padding:12px;overflow:auto;min-height:120px}
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card">
        <h1>OOH Toggle It — Live Flags</h1>
        <div class="muted">Enter a flag key and any user id (URL/string). Click Evaluate.</div>
      </div>

      <div class="grid" style="margin-top:16px">
        <div class="card">
          <h2>Inputs</h2>
          <div class="row" style="margin-top:8px">
            <label style="width:84px" for="flag">Flag</label>
            <input id="flag" value="welcome_banner" style="flex:1" />
          </div>
          <div class="row" style="margin-top:8px">
            <label style="width:84px" for="uid">User</label>
            <input id="uid" placeholder="user-id or URL" style="flex:1" />
          </div>
          <div class="row" style="margin-top:12px;justify-content:flex-end">
            <button id="btn-eval">Evaluate</button>
          </div>
        </div>

        <div class="card">
          <h2>Headers & Metrics</h2>
          <div class="row" style="gap:12px;flex-wrap:wrap">
            <span class="pill">RL Limit: <b id="h-limit">–</b></span>
            <span class="pill">RL Remaining: <b id="h-rem">–</b></span>
            <span class="pill">RL Reset: <b id="h-reset">–</b></span>
          </div>
        </div>
      </div>

      <div class="card" style="margin-top:16px">
        <h2>Result</h2>
        <pre id="eval-out" class="no">{ }</pre>
      </div>
    </div>
    <script src="/config.js"></script>
    <script type="module">
      const flag = document.querySelector('#flag');
      const uid  = document.querySelector('#uid');
      const out  = document.querySelector('#eval-out');

      const hLimit = document.querySelector('#h-limit');
      const hRem = document.querySelector('#h-rem');
      const hReset = document.querySelector('#h-reset');

      function show(e, isErr=true) {
        out.textContent = typeof e === 'string' ? e : JSON.stringify(e, null, 2);
        out.className = isErr ? 'no' : 'ok';
      }

      async function fetchJSON(url) {
        const t0 = performance.now();

        const key = (window.__EDGE_API_KEY || '').trim();
        const r = await fetch(url, {
          headers: key ? { 'x-api-key': key } : {},
        });

        const dt = performance.now() - t0;

        hLimit.textContent = r.headers.get('x-ratelimit-limit') ?? '–';
        hRem.textContent   = r.headers.get('x-ratelimit-remaining') ?? '–';
        hReset.textContent = r.headers.get('x-ratelimit-reset') ?? '–';

        if (!r.ok) {
          const body = await r.text();
          throw new Error(String(r.status) + ' ' + body);
        }
        const json = await r.json();
        json.latency_ms = Math.round(dt);
        return json;
      }


      async function runEval() {
        const f = (flag.value || '').trim();
        const u = (uid.value || '').trim() || 'anon';
        if (!f) return show('Missing flag');

        try {
          const q = new URLSearchParams({ flag: f, user: u });
          const data = await fetchJSON('/demo/eval?' + q.toString());
          show(data, /*isErr*/ false);
        } catch (e) {
          show(e instanceof Error ? e.message : String(e), true);
        }
      }

      document.querySelector('#btn-eval').addEventListener('click', runEval);
    </script>
  </body>
</html>
